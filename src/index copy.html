<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0" />
    <title>NiiVue</title>
    <link rel="stylesheet" href="niivue.css" />
    <link rel="icon" href="data:;base64,iVBORw0KGgo=" />
  </head>
  <body>
    <noscript>
      <strong>niivue requires JavaScript.</strong>
    </noscript>
    <header>
      <label for="layoutSelect">Layout</label>
      <select id="layoutSelect">
        <option value="0" selected>Auto</option>
        <option value="1">Column</option>
        <option value="2">Grid</option>
        <option value="3">Row</option>
      </select>
      <label for="renderingSelect">MultiplanarRendering</label>
      <select id="renderingSelect">
        <option value="0">Never</option>
        <option value="1">Always</option>
        <option value="2" selected>Auto</option>
      </select>
      <select id="sliceType">
        <option value="0">Axial</option>
        <option value="1">Coronal</option>
        <option value="2">Sagittal</option>
        <option value="4">Render</option>
        <option value="3" selected>Multiplanar</option>
      </select>
      <label for="equalCheck">EqualSize</label>
      <input type="checkbox" id="equalCheck" checked />
      <label for="heroSlider">Hero Image</label>
      <input
        type="range"
        min="0"
        max="9"
        value="0"
        class="slider"
        id="heroSlider"
      />
      <label for="gapSlider">Xhair Gap</label>
      <input
        type="range"
        min="0"
        max="9"
        value="2"
        class="slider"
        id="gapSlider"
      />
      <label for="rulerSlider">Ruler Thick</label>
      <input
        type="range"
        min="1"
        max="10"
        value="2"
        class="slider"
        id="rulerSlider"
      />
      <label for="thickSlider">Crosshair width</label>
      <input
        type="range"
        min="1"
        max="40"
        value="4"
        class="slider"
        id="thickSlider"
      />
      <label for="worldCheck">World space</label>
      <input type="checkbox" id="worldCheck" unchecked />
      <select id="crosshairUnits">
        <option value="voxels">Voxels</option>
        <option value="mm" selected>MM</option>
      </select>
    </header>
    <main id="canvas-container">

      <div style="display: flex; width: 100%; height: 100%;">

        <canvas id="gl1"></canvas>
    <input type="range" id="axSlider" min="0" max="100" data-axcorsag="0"
           style="position: absolute; visibility: hidden;">
    <input type="range" id="corSlider" min="0" max="100" data-axcorsag="1"
           style="position: absolute; visibility: hidden;">
    <input type="range" id="sagSlider" min="0" max="100" data-axcorsag="2"
           style="position: absolute; visibility: hidden;">
      </div>
    </main>
    <footer>
      <label id="statusLabel">&nbsp; </label>
    </footer>
    <script type="module" async>
      import {
        Niivue,
        NVImage,
        NVMesh,
        NVMeshLoaders,
        SHOW_RENDER,
        DRAG_MODE
      } from "./niivue/index.ts";
      thickSlider.oninput = function () {
        nv1.opts.crosshairWidth = this.value * 0.25
        nv1.drawScene()
      }
      crosshairUnits.onchange = function () {
        nv1.opts.crosshairWidthUnit = this.value
        nv1.drawScene()
      }
      worldCheck.onclick = function () {
        nv1.setSliceMM(this.checked);
        resizeSliders()
      }
      function resizeSlider(slider) {
        let ltwh = [-1, 0, 0, 0]
        let orient = parseInt(slider.dataset.axcorsag)
        for (let i = 0; i < nv1.screenSlices.length; i++) {
          if (nv1.screenSlices[i].axCorSag !== orient) {
            continue
          }
          ltwh = nv1.screenSlices[i].leftTopWidthHeight
          console.log(nv1.screenSlices[i])
          console.log(ltwh[1])
        }
        if (ltwh[0] < 0) {
          slider.style.visibility = "hidden";
          return
        }
        slider.style.visibility = "visible";
        slider.style.left = ltwh[0] + "px";
        let top = Math.max(ltwh[1] - nv1.opts.tileMargin, 0) 
        console.log(top)
        slider.style.top = top + "px";
        slider.style.width = ltwh[2] + "px";
      }
      function resizeSliders() {
        resizeSlider(axSlider)
        resizeSlider(corSlider)
        resizeSlider(sagSlider)
      }
      function resizeCanvas() {
        resizeSliders()
      }
      function moveSlider() {
        nv1.scene.crosshairPos = [sagSlider.value / 100, corSlider.value / 100, axSlider.value / 100]
        nv1.drawScene()
      }
      axSlider.oninput = function () {
        moveSlider()
      }
      corSlider.oninput = function () {
        moveSlider()
      }
      sagSlider.oninput = function () {
        moveSlider()
      }
      gapSlider.oninput = function () {
        nv1.opts.crosshairGap = this.value * 2
        nv1.updateGLVolume()
      }
      rulerSlider.oninput = function () {
        nv1.opts.rulerWidth = Number(this.value)
        nv1.updateGLVolume()
      }
      layoutSelect.onchange = function () {
        nv1.setMultiplanarLayout(Number(this.value));
        resizeSliders
      }
      renderingSelect.onchange = function () {
        nv1.opts.multiplanarShowRender =  Number(this.value);
        nv1.drawScene();
      }
      equalCheck.onchange = function () {
        nv1.opts.multiplanarEqualSize = this.checked
        nv1.drawScene()
      }
      heroSlider.oninput = function () {
        nv1.setHeroImage(this.value * 0.1)
        resizeSliders()
      }
      sliceType.onchange = function () {
        let st = parseInt(document.getElementById("sliceType").value);
        nv1.setSliceType(st)
        resizeSliders()
      }
      var volumeList1 = [{ url: "../demos/images/fslmean.nii.gz" }];
      const onLocationChange = (data) => {
        statusLabel.innerHTML ="&nbsp;&nbsp;" + data.string;
        let fracXYZ = nv1.scene.crosshairPos
        axSlider.value = Math.round(fracXYZ[2] * 100)
        corSlider.value = Math.round(fracXYZ[1] * 100)
        sagSlider.value = Math.round(fracXYZ[0] * 100)
      };
      let defaults = {
        backColor: [0, 0.2, 0.4, 1],
        show3Dcrosshair: true,
        loglevel: 'debug',
        isRuler: true,
        dragMode: DRAG_MODE.measurement,
        // onDragRelease: onDragRelease,
        onLocationChange: onLocationChange,
        measureTextJustify: 'start',
        showMeasureUnits: true,
        measureTextColor: [0, 1, 0, 1],
        measureLineColor: [1, 0, 0, 1],
        measureTextHeight: 0.04
      };
      var nv1 = new Niivue(defaults);
      nv1.opts.tileMargin = 40
      nv1.attachToCanvas(gl1)
      // multiplanarShowRender is the preferred option now, 
      // but multiplanarForceRender is still available for backwards compatibility
      // previous use was: nv1.opts.multiplanarForceRender = true;
      nv1.opts.multiplanarShowRender = SHOW_RENDER.AUTO
      nv1.opts.yoke3Dto2DZoom = true;
      await nv1.loadVolumes(volumeList1);
      nv1.setSelectionBoxColor([0, 1, 0, 0.5]);
      nv1.opts.fontColor = [1, 1, 1, 1]
      nv1.opts.textHeight = 0.05
      equalCheck.onchange()
      rulerSlider.oninput()
      gapSlider.oninput()
      thickSlider.oninput()
      crosshairUnits.onchange()
      window.addEventListener("resize", resizeCanvas);
      await nv1.drawScene()
      resizeSliders()
      //nv1.setSliceType(nv1.sliceTypeAxial)
    </script>
  </body>
</html>